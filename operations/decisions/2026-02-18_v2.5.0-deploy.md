# v2.5.0 デプロイ記録 (2026-02-18)

## 概要
http-functions.js v2.5.0 デプロイ + LINE Bot 予約リンク即返し機能の実装

## Wix http-functions.js 変更内容
### 新規エンドポイント
- get_a2a_booking_link: 空き確認+予約フォームURL+クーポン一括返却
  - service_key のみで利用可能（service_wix_id 省略可）
  - SERVICE_KEY_TO_WIX_ID マップで自動解決（14サービス対応）
  - line_message フィールドをそのまま LINE Bot の返信に使える
  - Wix Shareable Booking Form Links 準拠（日時プリセレクト済み）

### GET フォールバック追加
- get_a2a_availability: パラメータなしでヘルプ JSON（500を200に修正）
- get_a2a_book: POST 使い方ガイド
- get_a2a_rpc: JSON-RPC 使い方ガイド
- get_a2a: ゲートウェイ使い方ガイド

### その他
- llm.txt / llms.txt に HTTP メソッド明記、Knowledge Base URL 追加
- カタログに coupon セクション追加
- 全14エンドポイントが GET で 200 OK を返す状態

## クーポン仕様
- コード: WELCOME10（Wix ダッシュボードで作成済み）
- Wix チェックアウト画面で手動入力
- 1顧客1回限り（Wix 自動判定、2回目以降は割引なし・エラーなし）
- 全ユーザーに案内 OK（Bot 側で初回判定不要）

## LINE Bot 変更内容 (iMac ~/hs_a2a/)
### 新規ファイル
- booking_link_helper.py: a2a_booking_link 呼び出しヘルパー
  - detect_booking_link_intent(): ユーザー発話から施設+日付+時刻を抽出
  - call_booking_link_sync(): Wix API を同期呼び出し、line_message を返す
  - SERVICE_KEYWORD_MAP: 25キーワード → service_key マッピング
  - DURATION_SUFFIX: 3h/6h/8h → service_key サフィックス自動付与

### line_bot_server.py 変更
- Layer 0 改修: 日時+施設が揃った予約意図は faq_matcher をスキップして Layer 1A へ
- Layer 1A 追加: booking_link_helper で予約URL即返し
- 名前・メール収集フロー（booking_state 系）削除: Wix 予約フォームで入力するため不要
- execute_booking 関数削除

### 処理優先順位（更新後）
1. 管理者コマンド（hs:3人 等）
2. Layer 0: パターンマッチ（218パターン）※日時付き予約意図はスキップ
3. Layer 1A: booking_link_helper（施設+日付+時刻で予約URL+クーポン即返し）
4. Layer 1B: prepare_layer1_booking（Layer 1A 失敗時フォールバック）
5. Layer 2: hs_reply_state.py + offers.csv
6. Layer 3: jan_client.py（ローカル LLM）
7. Layer 4: フォールバック

## ユーザー体験
ユーザー: 明日9時に会議室
Bot: 日時プリセレクト済み予約URL + クーポンコード WELCOME10 を即返し
リンクタップでカレンダー日時選択済み状態で開く

## 技術的な注意点
- Python 3.9 環境: str | None 型ヒントは使用不可（str に変更済み）
- httpx パッケージ追加済み
- iMac の uvicorn は LaunchAgent で自動起動
